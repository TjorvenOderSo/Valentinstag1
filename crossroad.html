<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Crossroad</title>
<style>
body{ margin:0; overflow:hidden; background:#87ceeb;}
canvas{ display:block; }
#hud{
  position:absolute; top:10px; left:10px; color:white; font-family:sans-serif; font-size:22px;
}
#gameOver{
  position:absolute; top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.7);
  color:white; font-family:sans-serif;
  display:flex; justify-content:center; align-items:center;
  flex-direction:column; font-size:30px;
  display:none;
}
#gameOver button{
  margin-top:20px; padding:10px 20px; font-size:24px; cursor:pointer;
  background:#ff4fa0; border:none; color:white; border-radius:8px;
}
</style>
</head>
<body>

<canvas id="game"></canvas>
<div id="hud">Herzen: 0 / 20 | Leben: 3</div>

<div id="gameOver">
  <div>Game Over!</div>
  <button onclick="restartGame()">Neu starten</button>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// Ball (jetzt schneller!)
let ball = {x:canvas.width/2, y:canvas.height-80, radius:25, speed:12, lives:3};

// Ziel
let hearts = 0;
const targetHearts = 20;

// Fallende Herzen
let heartItems = [];
const heartFallSpeed = 2.5; // langsamer als Autos

// Autos
let cars = [];
const carSpeed = 6;
const carWidth = 90;
const carHeight = 45;

// Leitplanken
const barriers = [
  {x:0, y:0, width:60, height:canvas.height},
  {x:canvas.width-60, y:0, width:60, height:canvas.height}
];

const gameOverDiv = document.getElementById("gameOver");

// Autos erzeugen
function spawnCars(){
  if(cars.length < 6){
    const laneX = 60 + Math.random()*(canvas.width-120-carWidth);
    cars.push({x:laneX, y:-50, width:carWidth, height:carHeight});
  }
}

// Herzen erzeugen (fallen von oben!)
function spawnHearts(){
  if(heartItems.length < 4){
    const hx = 60 + Math.random()*(canvas.width-120);
    heartItems.push({x:hx, y:-30, radius:18});
  }
}

function drawBall(){
  ctx.fillStyle="#ff4fa0";
  ctx.beginPath();
  ctx.arc(ball.x, ball.y, ball.radius,0,Math.PI*2);
  ctx.fill();
}

function drawCars(){
  ctx.fillStyle="red";
  cars.forEach(c=>{
    ctx.fillRect(c.x, c.y, c.width, c.height);
  });
}

function drawHearts(){
  ctx.fillStyle="pink";
  heartItems.forEach(h=>{
    ctx.beginPath();
    ctx.arc(h.x, h.y, h.radius,0,Math.PI*2);
    ctx.fill();
  });
}

function drawBarriers(){
  ctx.fillStyle="#444";
  barriers.forEach(b=>{
    ctx.fillRect(b.x,b.y,b.width,b.height);
  });
}

function update(){

  // Autos bewegen
  cars.forEach(c=> c.y += carSpeed);
  cars = cars.filter(c=>c.y<canvas.height+60);

  // Herzen bewegen (langsamer!)
  heartItems.forEach(h=> h.y += heartFallSpeed);
  heartItems = heartItems.filter(h=>h.y<canvas.height+40);

  // Herz sammeln
  heartItems.forEach((h,i)=>{
    const dx = h.x - ball.x;
    const dy = h.y - ball.y;
    const dist = Math.sqrt(dx*dx + dy*dy);
    if(dist < h.radius + ball.radius){
      hearts++;
      heartItems.splice(i,1);
    }
  });

  // Auto Kollision
  cars.forEach((c,i)=>{
    if(ball.x + ball.radius > c.x && ball.x - ball.radius < c.x + c.width &&
       ball.y + ball.radius > c.y && ball.y - ball.radius < c.y + c.height){
      ball.lives--;
      cars.splice(i,1);
    }
  });

  // Barrieren Kollision
  barriers.forEach(b=>{
    if(ball.x + ball.radius > b.x && ball.x - ball.radius < b.x + b.width){
      ball.lives--;
      if(b.x < canvas.width/2) ball.x = b.x + b.width + ball.radius + 1;
      else ball.x = b.x - ball.radius -1;
    }
  });

  if(ball.lives <= 0){
    showGameOver();
  }

  if(hearts >= targetHearts){
    setTimeout(()=>{ location.href="finalstory.html"; },500);
  }

  document.getElementById("hud").innerText =
    `Herzen: ${hearts} / ${targetHearts} | Leben: ${ball.lives}`;
}

// Dauerhafte Bewegung bei gedrÃ¼ckter Taste
const keys = {};
document.addEventListener("keydown",(e)=> keys[e.key]=true);
document.addEventListener("keyup",(e)=> keys[e.key]=false);

function handleMovement(){
  if(keys["ArrowLeft"] || keys["a"]) ball.x -= ball.speed;
  if(keys["ArrowRight"] || keys["d"]) ball.x += ball.speed;
  if(keys["ArrowUp"] || keys["w"]) ball.y -= ball.speed;
  if(keys["ArrowDown"] || keys["s"]) ball.y += ball.speed;

  // Obere / untere Begrenzung
  if(ball.y < 0) ball.y = 0;
  if(ball.y > canvas.height-ball.radius) ball.y = canvas.height-ball.radius;
}

function showGameOver(){
  gameOverDiv.style.display = "flex";
}

function restartGame(){
  ball.x = canvas.width/2;
  ball.y = canvas.height-80;
  ball.lives = 3;
  hearts = 0;
  cars = [];
  heartItems = [];
  gameOverDiv.style.display = "none";
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  handleMovement();
  drawBarriers();
  drawHearts();
  drawBall();
  drawCars();
  update();

  spawnCars();
  spawnHearts();

  requestAnimationFrame(draw);
}

draw();
</script>

</body>
</html>
